<h2 align="center">Скрипт для скачивания фотографий пользователей / групп / бесед ВКонтакте</h2>

<div align="center">
	<a href="https://github.com/SolitarySpiral/vkd">
		<img src="https://img.shields.io/github/stars/SolitarySpiral/vkd" alt="Stars Badge"/>
	</a>	
</div>

### Что это и с чем едят:
Скриптом можно скачать 
* все фотографии и видео из группы
* все фотографии пользователя
* все фотографии из вложения чата
* все аудио пользователя

### Системные требования:

* Python 3.13 и выше
* VSCode для удобного запуска скрипта
* Доступ к интернету

### Как использовать:

1. Скачиваем зависимости для скрипта и для yt-dlp:
```bash
pip install poetry
poetry update

winget install ffmpeg
```
2. Перезапускаем VSCode.

3. Создать файл config.yaml, если он отсутствует? в той же директории, где и сам файл vkd.py
В файл config.yaml вписываем токен от ВКонтакте, он временный, выглядит как длинная строка начинаяющаяся на ```Vk.a``` до ```&expired_on```:
```yaml
token: ""  # Ваш токен
```
***Токен получать [тут](https://vkhost.github.io/) для vk.com***

4. Текущий вариант скрипта поддерживает аргументы командной строки. Основной запуск имеет вид ```python vkd.py [--photos] [--videos] [--wall] [--chat] vk_ids```
*  Необходимо выбрать параметры запуска и передать ссылку на:
1. Чат с пользователем (https://vk.com/im/convo/187210311) Пример запуска: ```python vkd.py --photos --chat https://vk.com/im/convo/187210311```
2. Чат с группой (https://vk.com/im/convo/-218070649) Пример запуска: ```python vkd.py --photos --chat https://vk.com/im/convo/-218070649```
3. Ссылку на группу(https://vk.com/seeu_off) Пример запуска: ```python vkd.py --photos --videos --wall https://vk.com/seeu_off```
4. Ссылку на пользователя(https://vk.com/octamillia). Пример запуска: ```python vkd.py --photos --videos --wall https://vk.com/octamillia```
5. id в виде числа, будь то группа, чат или пользователь. Если это чат, необходим аргумент --chat. Иначе загрузка будет у группы или пользователя соответственно.
Пример запуска: ```python vkd.py --photos --videos --chat -218070649```
6. Старые форматы ссылок на пользователя и групп. (club123, public456, id789). Но не поддерживаются старые форматы ссылок на чат в ранних версиях вконтакте.
7. (experimental) Загрузка аудио пользователя. Пример запуска: ```python vkd.py -a https://vk.com/octamillia```

### Пара тонкостей
* (experimental) Можно передать список ссылок через запятую без пробелов чего-то одного из вариантов выше. (Для аудио список не поддерживается)
* Совмещать разные ссылки нельзя. Пограмма не поймет что вы ей дали, список пользователей, или список групп. Сломается и всё(
* Если доступа к пользователю, группе у вас нет, то при попытке скачать будет ошибка, и всё сломается.
* yt-dlp не поддерживает загрузку некоторых видов видео.
* В версии 0.0.5+ добавлено получение прокси для yt-dlp. Это актуально для ру сегмента. Загрузка видео через прокси ```python vkd.py --videos --use-proxy https://vk.com/me_sunako```
* В версии 0.0.6+ добавлена возможность загружать аудио из ВК. Поддержка коротких названий параметров вместо --video можно -v.

### О аудио: важная инфа!
Официально апи вк для аудио нет! 
Этот альтернативный способ крайне ненадёжный. 
Сегменты аудиофалов могут быть сломанными, отсутствовать и иметь другой вид шифрования, отличный от AES128.
На самом деле файлы .ts не плохо запускаются в большинстве аудиопроигрывателей, можно даже обойтись и без перекодировки в mp3.
Ffmpeg не поддерживает ситуации, когда сегменты шифрованы не все в плейлисте m3u8. В ручном варианте работы с .ts файлы в целом загружаются корректные.

Если работать только с аудио, можно запускать только сам скрипт ```vk_audio_decypror.py ```
### О аудио: Как это работает?
Вконтакте предоставляет плейлисты, где используется смешанное шифрование:

#EXT-X-KEY:METHOD=AES-128,URI="..." — указывает, что следующий сегмент зашифрован.
#EXT-X-KEY:METHOD=NONE — указывает, что следующие за ним сегменты не зашифрованы, до тех пор, пока снова не появится ключ AES-128.
Такое частое переключение между зашифрованным и открытым состоянием — нетипичная, но валидная конфигурация, которая может путать ffmpeg или yt-dlp, заставляя их преждевременно завершать работу.

Этот скрипт, будет вручную выполнять весь процесс:

Проанализирует M3U8: Определит, какой сегмент каким ключом зашифрован (или не зашифрован).
Асинхронно скачает всё: Параллельно загрузит все .ts сегменты и все уникальные ключи шифрования.
Расшифрует нужное: Расшифрует только те сегменты, для которых был указан ключ, используя стандарт AES-128.
Соберёт всё воедино: Соединит все сегменты (расшифрованные и изначально открытые) в правильном порядке в один финальный файл.

Не судите сторого, у меня лапки и клешни из точки G, и F21.
